## Introduction

ChIP-Seq is widely used to characterize genome-wide binding patterns of transcription factors and other chromatin-associated proteins. Although comparison of ChIP-Seq data sets is critical for understanding cell type-dependent and cell state-specific binding, and thus the study of cell-specific gene regulation, few quantitative approaches have been developed. 

Here, we present a simple and effective method, MAnorm, for quantitative comparison of ChIP-Seq data sets describing transcription factor binding sites and epigenetic modifications. The quantitative binding differences inferred by MAnorm showed strong correlation with both the changes in expression of target genes and the binding of cell type-specific regulators.

## Requirements

- Python >= 3.7
- numpy >= 1.20
- scipy >= 1.7
- matplotlib >= 3.5
- pandas >= 1.3
- statsmodels >= 0.13

## Installation

### Via pip (recommended)

```bash
pip install .
```

For development mode:

```bash
pip install -e .
```

### Via setup.py

```bash
python setup.py install
```

After installation, the `manormfast` command will be available, or you can run directly:

```bash
python bin/MAnormFast --help
```

## Command

**Input:**
There are five required arguments: 2 peaks files, 2 reads files, and an output folder name:

```bash
python bin/MAnormFast --p1 peak1.bed --r1 read1.bed --p2 peak2.bed --r2 read2.bed -o output_folder_name
```

**Note:** Peak file supports BED format and MACS output XLS format. The first three columns 
should be `chr start end`. If there is a summit column, it should be in the fourth column.

**Other Options:**
> **Note:** Use `--help` to see all available options.

## Output

MAnormFast generates the following outputs in the specified output folder:

| File/Directory | Description |
|---|---|
| `*_all_peak_MAvalues.xls` | Normalized peak table with M-values, A-values, and P-values |
| `output_figures/` | MA plots before/after normalization, read density scatter, P-value heatmap |
| `output_filters/` | Filtered biased and unbiased peaks in BED format |
| `output_wig_files/` | WIG tracks of normalized M-values and P-values for genome browsers |

### Output columns in MAvalues.xls

| Column | Description |
|---|---|
| chr, start, end | Genomic coordinates of the peak |
| summit | Summit position relative to peak start |
| M_value | Normalized log2 fold-change between two samples |
| A_value | Average signal intensity |
| P_value | Statistical significance of the binding difference |
| Peak_Group | Classification: unique to sample 1/2, or merged common peak |
| normalized_read_density_in_* | Normalized read density for each sample |

## Peak file format support

Standard BED format is supported. Additionally, 3-col tab-split format, 4-col tab-split format and MACS peak file formats are supported.

### 3-columns tab-split format

```
chr1	2345	4345
chr1	3456	5456
chr2	6543	8543
```

### 4-columns tab-split format

```
chr1	2345	4345	254
chr1	3456	5456	127
chr2	6543	8543	302
```

### MACS output peak file

```
# This file is generated by MACS
# ARGUMENTS LIST:
# name = A549_H3K27acEtoh02_Rep1
# format = BED
chr	start	end	length	summit	tags	-10*log10(pvalue)	fold_enrichment	FDR(%)
chr7	97911064	97917104	6041	368	648	3233.06	22.57	0.0
chr11	35159640	35167695	8056	1358	1066	3233.06	21.83	0.0
```

## Algorithm

MAnormFast implements the MAnorm algorithm which:

1. **Classifies peaks** into common (overlapping) and unique (sample-specific) groups
2. **Tests enrichment** of overlap via random permutation
3. **Merges common peaks** from both samples
4. **Calculates read density** in a window around each peak summit
5. **Fits a robust linear model** (M = a*A + b) using common peaks
6. **Normalizes** M-values and A-values based on the fitted model
7. **Computes P-values** for differential binding significance

## Reference

[Shao Z, Zhang Y, Yuan GC, Orkin SH, Waxman DJ. (2012) MAnorm: a robust model for quantitative comparison of ChIP-Seq data sets. Genome Biol. Mar 16;13(3):R16.](https://genomebiology.biomedcentral.com/articles/10.1186/gb-2012-13-3-r16)

## License

This project is licensed under the GNU General Public License v3.0 - see the [LICENSE](LICENSE) file for details.
